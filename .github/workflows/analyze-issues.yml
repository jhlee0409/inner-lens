# Trigger workflow for inner-lens AI Analysis
#
# Two trigger modes:
# 1. Automatic: When issue is created with 'inner-lens' label
# 2. Manual: workflow_dispatch for re-analyzing existing issues

name: Analyze Issues

on:
  issues:
    types: [opened]  # Only on issue creation - single event, no duplicates

  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to analyze'
        required: true
        type: number

# Prevent duplicate runs for the same issue
concurrency:
  group: analyze-issue-${{ github.event.issue.number || inputs.issue_number }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write

jobs:
  check:
    name: Check Conditions
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.result }}
      issue_number: ${{ steps.check.outputs.issue_number }}
    steps:
      - name: Check if should analyze
        id: check
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            // Get issue number from event or input
            const issueNumber = context.payload.issue?.number || ${{ inputs.issue_number || 0 }};

            if (!issueNumber) {
              console.log('‚ùå No issue number provided');
              return 'skip';
            }

            // Fetch issue details
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            const labels = issue.labels.map(l => typeof l === 'string' ? l : l.name);

            // For opened event: check if inner-lens label exists
            if (context.eventName === 'issues') {
              if (!labels.includes('inner-lens')) {
                console.log('‚è≠Ô∏è SKIP: No inner-lens label');
                return 'skip';
              }
            }

            // Skip if already analyzed (unless manual trigger)
            if (context.eventName !== 'workflow_dispatch') {
              if (labels.includes('status:analyzed')) {
                console.log('‚è≠Ô∏è SKIP: Already analyzed');
                return 'skip';
              }
            }

            // Check for existing analysis comment (skip for manual re-run)
            if (context.eventName !== 'workflow_dispatch') {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                per_page: 100
              });

              if (comments.some(c => c.body?.includes('## üîç inner-lens Analysis'))) {
                console.log('‚è≠Ô∏è SKIP: Analysis comment already exists');
                return 'skip';
              }
            }

            console.log(`‚úÖ Ready to analyze issue #${issueNumber}`);
            core.setOutput('issue_number', issueNumber);
            return 'run';
          result-encoding: string

  analyze:
    name: Run Analysis
    needs: check
    if: needs.check.outputs.should_run == 'run'
    uses: ./.github/workflows/analysis-engine.yml
    with:
      provider: 'anthropic'
      max_files: 25
      max_tokens: 4000
      language: 'ko'
    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
