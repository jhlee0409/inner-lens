# Trigger workflow for inner-lens AI Analysis
# This workflow triggers the reusable analysis-engine when issues are created/labeled
#
# Duplicate Prevention (2025) - CRITICAL:
# - Adds 'status:analyzing' label IMMEDIATELY when analysis starts (prevents race condition)
# - Checks for 'status:analyzing' OR 'status:analyzed' labels before running
# - Checks if analysis comment already exists
# - Uses concurrency control at both workflow and job levels

name: Analyze Issues

on:
  issues:
    types: [opened, labeled]

# Prevent race conditions: only one analysis per issue at a time
concurrency:
  group: analyze-issue-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  check-and-lock:
    name: Check & Lock for Analysis
    runs-on: ubuntu-latest
    outputs:
      should_analyze: ${{ steps.acquire-lock.outputs.should_analyze }}
    steps:
      - name: Check conditions and acquire lock
        id: acquire-lock
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const issue = context.payload.issue;
            const eventAction = context.payload.action;
            const addedLabel = context.payload.label?.name || '';

            console.log(`üìã Issue #${issue.number}: "${issue.title}"`);
            console.log(`üìå Event: ${eventAction}, Added label: ${addedLabel || 'N/A'}`);

            // Step 1: Get current labels (fresh from API to avoid race condition)
            const { data: issueData } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number
            });

            const currentLabels = issueData.labels.map(l => l.name);
            console.log(`üè∑Ô∏è Current labels: ${currentLabels.join(', ') || 'none'}`);

            // Step 2: Check if already analyzing or analyzed (SKIP if either exists)
            if (currentLabels.includes('status:analyzing')) {
              console.log('‚è≠Ô∏è SKIP: Analysis already in progress (status:analyzing label exists)');
              core.setOutput('should_analyze', 'false');
              return;
            }

            if (currentLabels.includes('status:analyzed')) {
              console.log('‚è≠Ô∏è SKIP: Already analyzed (status:analyzed label exists)');
              core.setOutput('should_analyze', 'false');
              return;
            }

            // Step 3: Check for existing analysis comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              per_page: 100
            });

            const hasAnalysisComment = comments.some(c =>
              c.body && c.body.includes('## üîç inner-lens Analysis')
            );

            if (hasAnalysisComment) {
              console.log('‚è≠Ô∏è SKIP: Analysis comment already exists');
              core.setOutput('should_analyze', 'false');
              return;
            }

            // Step 4: Determine if this event should trigger analysis
            let shouldAnalyze = false;

            if (eventAction === 'opened' && currentLabels.includes('bug')) {
              // Only trigger on 'opened' if inner-lens label is NOT present
              // (if inner-lens is present, the labeled event will handle it)
              if (currentLabels.includes('inner-lens')) {
                console.log('‚è≠Ô∏è SKIP opened event: inner-lens label present, will be handled by labeled event');
              } else {
                console.log('‚úÖ Trigger: New bug issue opened');
                shouldAnalyze = true;
              }
            } else if (eventAction === 'labeled' && addedLabel === 'inner-lens') {
              console.log('‚úÖ Trigger: inner-lens label was added');
              shouldAnalyze = true;
            }

            if (!shouldAnalyze) {
              console.log('‚è≠Ô∏è SKIP: No matching trigger condition');
              core.setOutput('should_analyze', 'false');
              return;
            }

            // Step 5: ACQUIRE LOCK - Add 'status:analyzing' label IMMEDIATELY
            // This prevents other concurrent workflows from also running analysis
            console.log('üîí Acquiring lock: Adding status:analyzing label...');
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['status:analyzing']
              });
              console.log('‚úÖ Lock acquired: status:analyzing label added');
              core.setOutput('should_analyze', 'true');
            } catch (error) {
              // If we fail to add the label, another workflow might have beat us
              console.log(`‚ö†Ô∏è Failed to acquire lock: ${error.message}`);
              core.setOutput('should_analyze', 'false');
            }

  analyze:
    name: Run Analysis
    needs: check-and-lock
    if: needs.check-and-lock.outputs.should_analyze == 'true'
    uses: ./.github/workflows/analysis-engine.yml
    with:
      provider: 'anthropic'
      max_files: 25
      max_tokens: 4000
      language: 'ko'
    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  cleanup-on-failure:
    name: Cleanup Lock on Failure
    needs: [check-and-lock, analyze]
    if: always() && needs.check-and-lock.outputs.should_analyze == 'true' && needs.analyze.result == 'failure'
    runs-on: ubuntu-latest
    steps:
      - name: Remove analyzing label on failure
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            console.log('üßπ Cleaning up: Removing status:analyzing label due to failure');
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                name: 'status:analyzing'
              });
            } catch (e) {
              console.log('Label might already be removed:', e.message);
            }
