# Trigger workflow for inner-lens AI Analysis
#
# SIMPLE RULE: Only triggers when 'inner-lens' label is added.
# This prevents duplicate runs - one event, one trigger, one analysis.

name: Analyze Issues

on:
  issues:
    types: [labeled]  # Only 'labeled' event - no duplicates possible

jobs:
  check:
    name: Check Conditions
    # Only run when 'inner-lens' label is added
    if: github.event.label.name == 'inner-lens'
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.result }}
    steps:
      - name: Check if already analyzed
        id: check
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const labels = context.payload.issue.labels.map(l => l.name);

            // Skip if already analyzed
            if (labels.includes('status:analyzed')) {
              console.log('‚è≠Ô∏è SKIP: Already analyzed');
              return 'skip';
            }

            // Check for existing analysis comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              per_page: 100
            });

            if (comments.some(c => c.body?.includes('## üîç inner-lens Analysis'))) {
              console.log('‚è≠Ô∏è SKIP: Analysis comment already exists');
              return 'skip';
            }

            console.log('‚úÖ Ready to analyze');
            return 'run';
          result-encoding: string

  analyze:
    name: Run Analysis
    needs: check
    if: needs.check.outputs.should_run == 'run'
    uses: ./.github/workflows/analysis-engine.yml
    with:
      provider: 'anthropic'
      max_files: 25
      max_tokens: 4000
      language: 'ko'
    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
