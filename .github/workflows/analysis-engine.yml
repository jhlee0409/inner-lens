# inner-lens Reusable Analysis Engine v2
# Enhanced with 2025 GitHub Actions best practices:
# - SHA pinning for supply chain security
# - Structured AI output with Zod schemas
# - Chain-of-Thought prompt engineering
# - Retry logic with exponential backoff
# - Automatic issue labeling
# - Concurrency control to prevent duplicate analysis (via concurrency setting)
#
# Usage in consumer repo:
#   uses: jhlee0409/inner-lens/.github/workflows/analysis-engine.yml@v1
#   with:
#     provider: 'anthropic'
#   secrets:
#     ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

name: inner-lens Analysis Engine

on:
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number to analyze (required for workflow_dispatch)'
        required: false
        type: string
      provider:
        description: 'AI Provider (anthropic, openai, google)'
        required: false
        type: string
        default: 'anthropic'
      model:
        description: 'AI Model name (e.g., claude-sonnet-4-20250514, gpt-4o, gemini-2.0-flash)'
        required: false
        type: string
        default: ''
      max_files:
        description: 'Maximum files to analyze (5-50)'
        required: false
        type: number
        default: 25
      max_tokens:
        description: 'Maximum tokens for AI response (1000-8000)'
        required: false
        type: number
        default: 4000
      node_version:
        description: 'Node.js version'
        required: false
        type: string
        default: '20'
      language:
        description: 'Output language for analysis (en, ko, ja, zh, es, de, fr, pt)'
        required: false
        type: string
        default: 'en'
    secrets:
      ANTHROPIC_API_KEY:
        required: false
        description: 'Anthropic API Key (required if provider is anthropic)'
      OPENAI_API_KEY:
        required: false
        description: 'OpenAI API Key (required if provider is openai)'
      GOOGLE_GENERATIVE_AI_API_KEY:
        required: false
        description: 'Google AI API Key (required if provider is google)'
      # Note: GITHUB_TOKEN is automatically available, no need to pass it

jobs:
  analyze:
    name: Analyze Bug Report
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # Prevent duplicate analysis for the same issue
    concurrency:
      group: inner-lens-analysis-${{ github.repository }}-${{ inputs.issue_number || github.event.issue.number }}
      cancel-in-progress: true  # Cancel previous runs

    permissions:
      issues: write
      contents: read

    steps:
      # SHA-pinned actions for supply chain security
      # Ref: https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions
      - name: Checkout caller repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: ${{ inputs.node_version }}

      - name: Checkout inner-lens scripts
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: jhlee0409/inner-lens
          ref: v1
          path: .inner-lens
          sparse-checkout: |
            scripts
            src/utils
          sparse-checkout-cone-mode: false
          persist-credentials: false

      - name: Cache npm dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-inner-lens-${{ hashFiles('.inner-lens/scripts/*.ts') }}
          restore-keys: |
            ${{ runner.os }}-npm-inner-lens-

      # Install dependencies in isolated environment to avoid peer dependency conflicts
      # with caller repository's package.json
      - name: Install analysis dependencies
        working-directory: .inner-lens
        run: |
          # Create isolated package.json to prevent npm from reading caller's package.json
          echo '{"name":"inner-lens-analysis","private":true,"type":"module"}' > package.json
          npm install --no-save --prefer-offline \
            ai@~6.0.12 \
            @ai-sdk/anthropic@~3.0.0 \
            @ai-sdk/openai@~3.0.0 \
            @ai-sdk/google@~3.0.0 \
            @octokit/rest@~21.0.2 \
            zod@~3.25.76 \
            tsx@~4.19.0

      - name: Validate inputs
        run: |
          # Validate provider
          if [[ ! "${{ inputs.provider }}" =~ ^(anthropic|openai|google)$ ]]; then
            echo "âŒ Invalid provider: ${{ inputs.provider }}"
            echo "   Valid options: anthropic, openai, google"
            exit 1
          fi

          # Validate API key is present for selected provider
          case "${{ inputs.provider }}" in
            anthropic)
              if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
                echo "âŒ ANTHROPIC_API_KEY secret is required for anthropic provider"
                exit 1
              fi
              ;;
            openai)
              if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
                echo "âŒ OPENAI_API_KEY secret is required for openai provider"
                exit 1
              fi
              ;;
            google)
              if [ -z "${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}" ]; then
                echo "âŒ GOOGLE_GENERATIVE_AI_API_KEY secret is required for google provider"
                exit 1
              fi
              ;;
          esac

          echo "âœ… Input validation passed"

      - name: Run analysis
        id: analysis
        env:
          AI_PROVIDER: ${{ inputs.provider }}
          AI_MODEL: ${{ inputs.model }}
          ISSUE_NUMBER: ${{ inputs.issue_number || github.event.issue.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          MAX_FILES: ${{ inputs.max_files }}
          MAX_TOKENS: ${{ inputs.max_tokens }}
          OUTPUT_LANGUAGE: ${{ inputs.language }}
          GITHUB_TOKEN: ${{ github.token }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_GENERATIVE_AI_API_KEY: ${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}
          NODE_PATH: ${{ github.workspace }}/.inner-lens/node_modules
        run: |
          echo "ğŸ” inner-lens Analysis Engine v2"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Issue: $REPO_OWNER/$REPO_NAME#$ISSUE_NUMBER"
          echo "ğŸ¤– Provider: $AI_PROVIDER"
          echo "ğŸ§  Model: ${AI_MODEL:-default}"
          echo "ğŸ“ Max Files: $MAX_FILES"
          echo "ğŸ“ Max Tokens: $MAX_TOKENS"
          echo "ğŸŒ Language: $OUTPUT_LANGUAGE"
          echo ""
          export PATH="${{ github.workspace }}/.inner-lens/node_modules/.bin:$PATH"
          tsx .inner-lens/scripts/analyze-issue.ts

      - name: Cleanup
        if: always()
        run: |
          rm -rf .inner-lens
          echo "ğŸ§¹ Cleanup complete"

      - name: Report failure
        if: failure()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ github.token }}
          script: |
            const issueNumber = ${{ inputs.issue_number || 0 }} || context.payload.issue?.number;
            if (!issueNumber) {
              console.log('No issue number available, skipping failure report');
              return;
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## âš ï¸ inner-lens Analysis Failed

            The automated analysis encountered an error. This could be due to:
            - API rate limiting
            - Network connectivity issues
            - Invalid issue format

            A maintainer will review this issue manually.

            <details>
            <summary>Workflow Details</summary>

            - **Run ID:** ${context.runId}
            - **Provider:** ${{ inputs.provider }}
            - **Timestamp:** ${new Date().toISOString()}

            </details>`
            });
